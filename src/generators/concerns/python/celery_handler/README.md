# Python Celery Handler

This module provides functionality to generate Celery background task processing setup for Python applications.

## Overview

The `PythonCeleryHandler` module is responsible for setting up Celery in Python applications generated by the Dwelling Model Builder. It handles the configuration, task creation, worker setup, and integration with different Python frameworks (FastAPI, Flask, and Django).

## Features

- Automatic Celery configuration based on application settings
- Generation of task modules for each defined batch job
- Worker configuration and setup
- Framework-specific integration (FastAPI, Flask, Django)
- Task monitoring and status endpoints
- Error handling and retry mechanisms

## Configuration

Celery is configured with the following default settings:

```ruby
@celery_config = {
  broker_url: 'redis://localhost:6379/0',
  result_backend: 'redis://localhost:6379/0',
  task_serializer: 'json',
  accept_content: ['json'],
  result_serializer: 'json',
  enable_utc: true,
  worker_concurrency: 4,
  task_acks_late: true,
  task_reject_on_worker_lost: true,
  task_time_limit: 30 * 60,  # 30 minutes
  task_soft_time_limit: 15 * 60  # 15 minutes
}
```

## Generated Files

The handler generates the following files and directories:

- `app/celery_config.py` - Celery configuration
- `app/tasks/` - Directory for task modules
  - `__init__.py` - Package initialization
  - `celery.py` - Celery app initialization
  - `{job_name}.py` - Task modules for each defined job
- `worker.py` - Worker script for running Celery workers
- Framework-specific route files for task management

## Framework Integration

### FastAPI Integration

For FastAPI applications, the handler:
- Creates a dedicated router for task management
- Adds endpoints for creating tasks and checking task status
- Integrates with the main FastAPI application

Example API usage:

```python
# Create a task
POST /tasks/process_data
{
  "user_id": 123,
  "data_type": "reports"
}

# Check task status
GET /tasks/process_data/550e8400-e29b-41d4-a716-446655440000
```

### Flask Integration

For Flask applications, the handler:
- Creates a Blueprint for task management
- Adds routes for creating tasks and checking task status
- Registers the Blueprint with the main Flask application

### Django Integration

For Django applications, the handler:
- Creates a dedicated Django app for tasks
- Sets up URL patterns for task management
- Configures Celery in the Django settings
- Integrates with the Django project structure

## Task Structure

Each generated task includes:

- Task definition with retry configuration
- Logging setup
- Error handling with automatic retries
- Simulated processing with configurable duration
- Result formatting

Example task:

```python
@shared_task(
    name='tasks.process_data',
    bind=True,
    max_retries=3,
    default_retry_delay=300,  # 5 minutes
    acks_late=True
)
def process_data(self, **kwargs):
    """
    Process data in the background
    
    Args:
        **kwargs: Job parameters
        
    Returns:
        dict: Result of the job execution
    """
    job_id = self.request.id
    logger.info(f"Starting process_data job {job_id} with parameters: {kwargs}")
    
    try:
        # Task implementation
        # ...
        
        return {
            "job_id": job_id,
            "status": "completed",
            "result": "Processed data successfully",
            "parameters": kwargs
        }
        
    except Exception as e:
        # Error handling with retry logic
        # ...
```

## Usage in YAML Configuration

To enable Celery batch job processing in your application, define batch jobs in your YAML configuration:

```yaml
batch_jobs:
  - name: process_data
    description: Process data in the background
    processing_time: 5000
  - name: send_emails
    description: Send batch emails to users
    processing_time: 3000
```

## Methods

The handler includes the following methods:

- `initialize_celery_config` - Sets up Celery configuration
- `generate_celery_setup` - Generates the entire Celery setup
- `add_celery_dependencies` - Adds Celery and Redis to requirements.txt
- `generate_celery_config` - Creates the Celery configuration file
- `generate_task_modules` - Generates task modules for each job
- `generate_worker_config` - Creates the worker script
- `update_app_with_celery` - Updates the application with Celery integration
- Framework-specific update methods for FastAPI, Flask, and Django 